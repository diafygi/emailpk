<!DOCTYPE html>
<html>
    <!--
    EmailPK - Instant encrypted email

    Copyright (c) 2014 Daniel Roesler
    License: GPLv2

    ===Code and Documentation===
    https://github.com/diafygi/emailpk

    ===Description===
    This is a proof-of-concept that performs client-side public-key encryption
    for email. Emails themselves are used as the public keys and passphrases are
    used to derive the secret key. The advantage of this method is that no keys
    need to be stored. The user only needs to know emails (which are easily
    stored in their contact list) and a secret passphrase (which they can use
    a password manager for). This demo also uses the public compose APIs of
    several popular web-based email clients to allow for easy email sending.

    ===External Libraries===
    Three external libraries are included with this demo and are released under
    the following licenses:

    1. scrypt-async.js from https://github.com/dchest/scrypt-async-js (BSD)
    2. TweetNaCl.js from https://github.com/dchest/tweetnacl-js (Public Domain)
    3. Base58.js from https://gist.github.com/diafygi/90a3e80ca1c2793220e5/ (DWTFYW)

    ===Code Style===
    This code is meant to be auditable, so it is fairly verbose and commented.
    All code is contained in this one file, and there are five major sections
    (search for "<!--"):
    1. External libraries (minified with deep links)
    2. Core EmailPK library
    3. User Interface CSS
    4. User Interface HTML
    5. User Interface Javascript
    -->
    <head>
        <title>EmailPK - Instant encrypted email</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

        <!-- External Libraries -->
        <script>
            //Scrypt
            //Downloaded from https://raw.githubusercontent.com/dchest/scrypt-async-js/940cff15a5d627f6849b4cb52b2a949ffb31dfa1/scrypt-async.min.js
            /*!
             * Fast "async" scrypt implementation in JavaScript.
             * Copyright (c) 2013-2014 Dmitry Chestnykh | BSD License
             * https://github.com/dchest/scrypt-async-js
             */
            function scrypt(r,n,t,o,e,u,f,a){"use strict";function h(r){function n(r){for(var n=0,p=r.length;p>=64;){var l,v,g,y,w,d=o,A=e,b=u,m=f,I=a,j=h,x=c,E=s;for(v=0;16>v;v++)g=n+4*v,i[v]=(255&r[g])<<24|(255&r[g+1])<<16|(255&r[g+2])<<8|255&r[g+3];for(v=16;64>v;v++)l=i[v-2],y=(l>>>17|l<<15)^(l>>>19|l<<13)^l>>>10,l=i[v-15],w=(l>>>7|l<<25)^(l>>>18|l<<14)^l>>>3,i[v]=(y+i[v-7]|0)+(w+i[v-16]|0)|0;for(v=0;64>v;v++)y=(((I>>>6|I<<26)^(I>>>11|I<<21)^(I>>>25|I<<7))+(I&j^~I&x)|0)+(E+(t[v]+i[v]|0)|0)|0,w=((d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10))+(d&A^d&b^A&b)|0,E=x,x=j,j=I,I=m+y|0,m=b,b=A,A=d,d=y+w|0;o=o+d|0,e=e+A|0,u=u+b|0,f=f+m|0,a=a+I|0,h=h+j|0,c=c+x|0,s=s+E|0,n+=64,p-=64}}var t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],o=1779033703,e=3144134277,u=1013904242,f=2773480762,a=1359893119,h=2600822924,c=528734635,s=1541459225,i=new Array(64);n(r);var p,l=r.length%64,v=r.length/536870912|0,g=r.length<<3,y=56>l?56:120,w=r.slice(r.length-l,r.length);for(w.push(128),p=l+1;y>p;p++)w.push(0);return w.push(v>>>24&255),w.push(v>>>16&255),w.push(v>>>8&255),w.push(v>>>0&255),w.push(g>>>24&255),w.push(g>>>16&255),w.push(g>>>8&255),w.push(g>>>0&255),n(w),[o>>>24&255,o>>>16&255,o>>>8&255,o>>>0&255,e>>>24&255,e>>>16&255,e>>>8&255,e>>>0&255,u>>>24&255,u>>>16&255,u>>>8&255,u>>>0&255,f>>>24&255,f>>>16&255,f>>>8&255,f>>>0&255,a>>>24&255,a>>>16&255,a>>>8&255,a>>>0&255,h>>>24&255,h>>>16&255,h>>>8&255,h>>>0&255,c>>>24&255,c>>>16&255,c>>>8&255,c>>>0&255,s>>>24&255,s>>>16&255,s>>>8&255,s>>>0&255]}function c(r,n,t){function o(){for(var r=u-1;r>=u-4;r--){if(f[r]++,f[r]<=255)return;f[r]=0}}r=r.length<=64?r:h(r);var e,u=64+n.length+4,f=new Array(u),a=new Array(64),c=[];for(e=0;64>e;e++)f[e]=54;for(e=0;e<r.length;e++)f[e]^=r[e];for(e=0;e<n.length;e++)f[64+e]=n[e];for(e=u-4;u>e;e++)f[e]=0;for(e=0;64>e;e++)a[e]=92;for(e=0;e<r.length;e++)a[e]^=r[e];for(;t>=32;)o(),c=c.concat(h(a.concat(h(f)))),t-=32;return t>0&&(o(),c=c.concat(h(a.concat(h(f))).slice(0,t))),c}function s(r,n,t,o){var e,u,f=r[0]^n[t++],a=r[1]^n[t++],h=r[2]^n[t++],c=r[3]^n[t++],s=r[4]^n[t++],i=r[5]^n[t++],p=r[6]^n[t++],l=r[7]^n[t++],v=r[8]^n[t++],g=r[9]^n[t++],y=r[10]^n[t++],w=r[11]^n[t++],d=r[12]^n[t++],A=r[13]^n[t++],b=r[14]^n[t++],m=r[15]^n[t++],I=f,j=a,x=h,E=c,C=s,N=i,T=p,k=l,q=v,z=g,B=y,D=w,F=d,G=A,H=b,J=m;for(u=0;8>u;u+=2)e=I+F,C^=e<<7|e>>>25,e=C+I,q^=e<<9|e>>>23,e=q+C,F^=e<<13|e>>>19,e=F+q,I^=e<<18|e>>>14,e=N+j,z^=e<<7|e>>>25,e=z+N,G^=e<<9|e>>>23,e=G+z,j^=e<<13|e>>>19,e=j+G,N^=e<<18|e>>>14,e=B+T,H^=e<<7|e>>>25,e=H+B,x^=e<<9|e>>>23,e=x+H,T^=e<<13|e>>>19,e=T+x,B^=e<<18|e>>>14,e=J+D,E^=e<<7|e>>>25,e=E+J,k^=e<<9|e>>>23,e=k+E,D^=e<<13|e>>>19,e=D+k,J^=e<<18|e>>>14,e=I+E,j^=e<<7|e>>>25,e=j+I,x^=e<<9|e>>>23,e=x+j,E^=e<<13|e>>>19,e=E+x,I^=e<<18|e>>>14,e=N+C,T^=e<<7|e>>>25,e=T+N,k^=e<<9|e>>>23,e=k+T,C^=e<<13|e>>>19,e=C+k,N^=e<<18|e>>>14,e=B+z,D^=e<<7|e>>>25,e=D+B,q^=e<<9|e>>>23,e=q+D,z^=e<<13|e>>>19,e=z+q,B^=e<<18|e>>>14,e=J+H,F^=e<<7|e>>>25,e=F+J,G^=e<<9|e>>>23,e=G+F,H^=e<<13|e>>>19,e=H+G,J^=e<<18|e>>>14;n[o++]=r[0]=I+f|0,n[o++]=r[1]=j+a|0,n[o++]=r[2]=x+h|0,n[o++]=r[3]=E+c|0,n[o++]=r[4]=C+s|0,n[o++]=r[5]=N+i|0,n[o++]=r[6]=T+p|0,n[o++]=r[7]=k+l|0,n[o++]=r[8]=q+v|0,n[o++]=r[9]=z+g|0,n[o++]=r[10]=B+y|0,n[o++]=r[11]=D+w|0,n[o++]=r[12]=F+d|0,n[o++]=r[13]=G+A|0,n[o++]=r[14]=H+b|0,n[o++]=r[15]=J+m|0}function i(r,n,t,o,e){for(;e--;)r[n++]=t[o++]}function p(r,n,t,o,e){for(;e--;)r[n++]^=t[o++]}function l(r,n,t,o,e){i(r,0,n,t+16*(2*e-1),16);for(var u=0;2*e>u;u+=2)s(r,n,t+16*u,o+8*u),s(r,n,t+16*u+16,o+8*u+16*e)}function v(r,n,t){return r[n+16*(2*t-1)]}function g(r){for(var n=[],t=0;t<r.length;t++){var o=r.charCodeAt(t);128>o?n.push(o):o>127&&2048>o?(n.push(o>>6|192),n.push(63&o|128)):(n.push(o>>12|224),n.push(o>>6&63|128),n.push(64&o|128))}return n}function y(r){for(var n="0123456789abcdef".split(""),t=r.length,o=[],e=0;t>e;e++)o.push(n[r[e]>>>4&15]),o.push(n[r[e]>>>0&15]);return o.join("")}function w(r){for(var n,t,o,e,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),f=r.length,a=[],h=0;f>h;)n=f>h?r[h++]:0,t=f>h?r[h++]:0,o=f>h?r[h++]:0,e=(n<<16)+(t<<8)+o,a.push(u[e>>>18&63]),a.push(u[e>>>12&63]),a.push(u[e>>>6&63]),a.push(u[e>>>0&63]);return f%3>0&&(a[a.length-1]="=",f%3==1&&(a[a.length-2]="=")),a.join("")}function d(){for(var r=0;32*o>r;r++){var n=4*r;x[q+r]=(255&C[n+3])<<24|(255&C[n+2])<<16|(255&C[n+1])<<8|(255&C[n+0])<<0}}function A(r,n){for(var t=r;n>t;t+=2)i(E,32*t*o,x,q,32*o),l(N,x,q,z,o),i(E,32*(t+1)*o,x,z,32*o),l(N,x,z,q,o)}function b(r,n){for(var t=r;n>t;t+=2){var e=v(x,q,o)&k-1;p(x,q,E,32*e*o,32*o),l(N,x,q,z,o),e=v(x,z,o)&k-1,p(x,z,E,32*e*o,32*o),l(N,x,z,q,o)}}function m(){for(var r=0;32*o>r;r++){var n=x[q+r];C[4*r+0]=n>>>0&255,C[4*r+1]=n>>>8&255,C[4*r+2]=n>>>16&255,C[4*r+3]=n>>>24&255}}function I(r,n,t,o,e){!function u(){setTimeout(function(){o(r,n>r+t?r+t:n),r+=t,n>r?u():e()},0)}()}var j=1;if(1>t||t>31)throw new Error("scrypt: logN not be between 1 and 31");var x,E,C,N,T=1<<31>>>0,k=1<<t>>>0;if(o*j>=1<<30||o>T/128/j||o>T/256||k>T/128/o)throw new Error("scrypt: parameters are too large");"string"==typeof r&&(r=g(r)),"string"==typeof n&&(n=g(n)),"undefined"!=typeof Int32Array?(x=new Int32Array(64*o),E=new Int32Array(32*k*o),N=new Int32Array(16)):(x=[],E=[],N=new Array(16)),C=c(r,n,128*j*o);var q=0,z=32*o;u||(u=1e3),d(),I(0,k,2*u,A,function(){I(0,k,2*u,b,function(){m();var n=c(r,C,e);f("base64"==a?w(n):"hex"==a?y(n):n)})})}"undefined"!=typeof module&&(module.exports=scrypt);

            //TweetNaCl.js
            //Downloaded from https://raw.githubusercontent.com/dchest/tweetnacl-js/35d91b495e0fc9fcb3e812780bfb8e8bfb02ad99/nacl.min.js
            !function(r){"use strict";function n(r,n){return r<<n|r>>>32-n}function e(r,n){var e=255&r[n+3];return e=e<<8|255&r[n+2],e=e<<8|255&r[n+1],e<<8|255&r[n+0]}function t(r,n){var e=r[n]<<24|r[n+1]<<16|r[n+2]<<8|r[n+3],t=r[n+4]<<24|r[n+5]<<16|r[n+6]<<8|r[n+7];return new ln(e,t)}function o(r,n,e){var t;for(t=0;4>t;t++)r[n+t]=255&e,e>>>=8}function i(r,n,e){r[n]=e.hi>>24&255,r[n+1]=e.hi>>16&255,r[n+2]=e.hi>>8&255,r[n+3]=255&e.hi,r[n+4]=e.lo>>24&255,r[n+5]=e.lo>>16&255,r[n+6]=e.lo>>8&255,r[n+7]=255&e.lo}function a(r,n,e,t,o){var i,a=0;for(i=0;o>i;i++)a|=r[n+i]^e[t+i];return(1&a-1>>>8)-1}function f(r,n,e,t){return a(r,n,e,t,16)}function u(r,n,e,t){return a(r,n,e,t,32)}function c(r,t,i,a,f){var u,c,w,y=new Uint32Array(16),s=new Uint32Array(16),l=new Uint32Array(16),h=new Uint32Array(4);for(u=0;4>u;u++)s[5*u]=e(a,4*u),s[1+u]=e(i,4*u),s[6+u]=e(t,4*u),s[11+u]=e(i,16+4*u);for(u=0;16>u;u++)l[u]=s[u];for(u=0;20>u;u++){for(c=0;4>c;c++){for(w=0;4>w;w++)h[w]=s[(5*c+4*w)%16];for(h[1]^=n(h[0]+h[3]|0,7),h[2]^=n(h[1]+h[0]|0,9),h[3]^=n(h[2]+h[1]|0,13),h[0]^=n(h[3]+h[2]|0,18),w=0;4>w;w++)y[4*c+(c+w)%4]=h[w]}for(w=0;16>w;w++)s[w]=y[w]}if(f){for(u=0;16>u;u++)s[u]=s[u]+l[u]|0;for(u=0;4>u;u++)s[5*u]=s[5*u]-e(a,4*u)|0,s[6+u]=s[6+u]-e(t,4*u)|0;for(u=0;4>u;u++)o(r,4*u,s[5*u]),o(r,16+4*u,s[6+u])}else for(u=0;16>u;u++)o(r,4*u,s[u]+l[u]|0)}function w(r,n,e,t){return c(r,n,e,t,!1),0}function y(r,n,e,t){return c(r,n,e,t,!0),0}function s(r,n,e,t,o,i,a){var f,u,c=new Uint8Array(16),y=new Uint8Array(64);if(!o)return 0;for(u=0;16>u;u++)c[u]=0;for(u=0;8>u;u++)c[u]=i[u];for(;o>=64;){for(w(y,c,a,Bn),u=0;64>u;u++)r[n+u]=(e?e[t+u]:0)^y[u];for(f=1,u=8;16>u;u++)f=f+(255&c[u])|0,c[u]=255&f,f>>>=8;o-=64,n+=64,e&&(t+=64)}if(o>0)for(w(y,c,a,Bn),u=0;o>u;u++)r[n+u]=(e?e[t+u]:0)^y[u];return 0}function l(r,n,e,t,o){return s(r,n,null,0,e,t,o)}function h(r,n,e,t,o){var i=new Uint8Array(32);return y(i,t,o,Bn),l(r,n,e,t.subarray(16),i)}function g(r,n,e,t,o,i,a){var f=new Uint8Array(32);return y(f,i,a,Bn),s(r,n,e,t,o,i.subarray(16),f)}function v(r,n){var e,t=0;for(e=0;17>e;e++)t=t+(r[e]+n[e]|0)|0,r[e]=255&t,t>>>=8}function p(r,n,e,t,o,i){var a,f,u,c,w=new Uint32Array(17),y=new Uint32Array(17),s=new Uint32Array(17),l=new Uint32Array(17),h=new Uint32Array(17);for(u=0;17>u;u++)y[u]=s[u]=0;for(u=0;16>u;u++)y[u]=i[u];for(y[3]&=15,y[4]&=252,y[7]&=15,y[8]&=252,y[11]&=15,y[12]&=252,y[15]&=15;o>0;){for(u=0;17>u;u++)l[u]=0;for(u=0;16>u&&o>u;++u)l[u]=e[t+u];for(l[u]=1,t+=u,o-=u,v(s,l),f=0;17>f;f++)for(w[f]=0,u=0;17>u;u++)w[f]=w[f]+s[u]*(f>=u?y[f-u]:320*y[f+17-u]|0)|0|0;for(f=0;17>f;f++)s[f]=w[f];for(c=0,u=0;16>u;u++)c=c+s[u]|0,s[u]=255&c,c>>>=8;for(c=c+s[16]|0,s[16]=3&c,c=5*(c>>>2)|0,u=0;16>u;u++)c=c+s[u]|0,s[u]=255&c,c>>>=8;c=c+s[16]|0,s[16]=c}for(u=0;17>u;u++)h[u]=s[u];for(v(s,Sn),a=0|-(s[16]>>>7),u=0;17>u;u++)s[u]^=a&(h[u]^s[u]);for(u=0;16>u;u++)l[u]=i[u+16];for(l[16]=0,v(s,l),u=0;16>u;u++)r[n+u]=s[u];return 0}function b(r,n,e,t,o,i){var a=new Uint8Array(16);return p(a,0,e,t,o,i),f(r,n,a,0)}function A(r,n,e,t,o){var i;if(32>e)return-1;for(g(r,0,n,0,e,t,o),p(r,16,r,32,e-32,r),i=0;16>i;i++)r[i]=0;return 0}function _(r,n,e,t,o){var i,a=new Uint8Array(32);if(32>e)return-1;if(h(a,0,32,t,o),0!==b(n,16,n,32,e-32,a))return-1;for(g(r,0,n,0,e,t,o),i=0;32>i;i++)r[i]=0;return 0}function d(r,n){var e;for(e=0;16>e;e++)r[e]=0|n[e]}function U(r){var n,e;for(e=0;16>e;e++)r[e]+=65536,n=Math.floor(r[e]/65536),r[(e+1)*(15>e?1:0)]+=n-1+37*(n-1)*(15===e?1:0),r[e]-=65536*n}function E(r,n,e){for(var t,o=~(e-1),i=0;16>i;i++)t=o&(r[i]^n[i]),r[i]^=t,n[i]^=t}function x(r,n){var e,t,o,i=hn(),a=hn();for(e=0;16>e;e++)a[e]=n[e];for(U(a),U(a),U(a),t=0;2>t;t++){for(i[0]=a[0]-65517,e=1;15>e;e++)i[e]=a[e]-65535-(i[e-1]>>16&1),i[e-1]&=65535;i[15]=a[15]-32767-(i[14]>>16&1),o=i[15]>>16&1,i[14]&=65535,E(a,i,1-o)}for(e=0;16>e;e++)r[2*e]=255&a[e],r[2*e+1]=a[e]>>8}function m(r,n){var e=new Uint8Array(32),t=new Uint8Array(32);return x(e,r),x(t,n),u(e,0,t,0)}function B(r){var n=new Uint8Array(32);return x(n,r),1&n[0]}function S(r,n){var e;for(e=0;16>e;e++)r[e]=n[2*e]+(n[2*e+1]<<8);r[15]&=32767}function K(r,n,e){var t;for(t=0;16>t;t++)r[t]=n[t]+e[t]|0}function T(r,n,e){var t;for(t=0;16>t;t++)r[t]=n[t]-e[t]|0}function Y(r,n,e){var t,o,i=new Float64Array(31);for(t=0;31>t;t++)i[t]=0;for(t=0;16>t;t++)for(o=0;16>o;o++)i[t+o]+=n[t]*e[o];for(t=0;15>t;t++)i[t]+=38*i[t+16];for(t=0;16>t;t++)r[t]=i[t];U(r),U(r)}function L(r,n){Y(r,n,n)}function C(r,n){var e,t=hn();for(e=0;16>e;e++)t[e]=n[e];for(e=253;e>=0;e--)L(t,t),2!==e&&4!==e&&Y(t,t,n);for(e=0;16>e;e++)r[e]=t[e]}function R(r,n){var e,t=hn();for(e=0;16>e;e++)t[e]=n[e];for(e=250;e>=0;e--)L(t,t),1!==e&&Y(t,t,n);for(e=0;16>e;e++)r[e]=t[e]}function k(r,n,e){var t,o,i=new Uint8Array(32),a=new Float64Array(80),f=hn(),u=hn(),c=hn(),w=hn(),y=hn(),s=hn();for(o=0;31>o;o++)i[o]=n[o];for(i[31]=127&n[31]|64,i[0]&=248,S(a,e),o=0;16>o;o++)u[o]=a[o],w[o]=f[o]=c[o]=0;for(f[0]=w[0]=1,o=254;o>=0;--o)t=i[o>>>3]>>>(7&o)&1,E(f,u,t),E(c,w,t),K(y,f,c),T(f,f,c),K(c,u,w),T(u,u,w),L(w,y),L(s,f),Y(f,c,f),Y(c,u,y),K(y,f,c),T(f,f,c),L(u,f),T(c,w,s),Y(f,c,_n),K(f,f,w),Y(c,c,f),Y(f,w,s),Y(w,u,a),L(u,y),E(f,u,t),E(c,w,t);for(o=0;16>o;o++)a[o+16]=f[o],a[o+32]=c[o],a[o+48]=u[o],a[o+64]=w[o];var l=a.subarray(32),h=a.subarray(16);return C(l,l),Y(h,h,l),x(r,h),0}function z(r,n){return k(r,n,pn)}function P(r,n){return gn(n,32),z(r,n)}function F(r,n,e){var t=new Uint8Array(32);return k(t,e,n),y(r,vn,t,Bn)}function N(r,n,e,t,o,i){var a=new Uint8Array(32);return F(a,o,i),Kn(r,n,e,t,a)}function O(r,n,e,t,o,i){var a=new Uint8Array(32);return F(a,o,i),Tn(r,n,e,t,a)}function M(){var r,n,e,t=0,o=0,i=0,a=0,f=65535;for(e=0;e<arguments.length;e++)r=arguments[e].lo,n=arguments[e].hi,t+=r&f,o+=r>>>16,i+=n&f,a+=n>>>16;return o+=t>>>16,i+=o>>>16,a+=i>>>16,new ln(i&f|a<<16,t&f|o<<16)}function G(r,n){return new ln(r.hi>>>n,r.lo>>>n|r.hi<<32-n)}function I(){var r,n=0,e=0;for(r=0;r<arguments.length;r++)n^=arguments[r].lo,e^=arguments[r].hi;return new ln(e,n)}function Z(r,n){var e,t,o=32-n;return 32>n?(e=r.hi>>>n|r.lo<<o,t=r.lo>>>n|r.hi<<o):64>n&&(e=r.lo>>>n|r.hi<<o,t=r.hi>>>n|r.lo<<o),new ln(e,t)}function j(r,n,e){var t=r.hi&n.hi^~r.hi&e.hi,o=r.lo&n.lo^~r.lo&e.lo;return new ln(t,o)}function V(r,n,e){var t=r.hi&n.hi^r.hi&e.hi^n.hi&e.hi,o=r.lo&n.lo^r.lo&e.lo^n.lo&e.lo;return new ln(t,o)}function q(r){return I(Z(r,28),Z(r,34),Z(r,39))}function X(r){return I(Z(r,14),Z(r,18),Z(r,41))}function D(r){return I(Z(r,1),Z(r,8),G(r,7))}function H(r){return I(Z(r,19),Z(r,61),G(r,6))}function J(r,n,e){var o,a,f,u=[],c=[],w=[],y=[];for(a=0;8>a;a++)u[a]=w[a]=t(r,8*a);for(var s=0;e>=128;){for(a=0;16>a;a++)y[a]=t(n,8*a+s);for(a=0;80>a;a++){for(f=0;8>f;f++)c[f]=w[f];for(o=M(w[7],X(w[4]),j(w[4],w[5],w[6]),Yn[a],y[a%16]),c[7]=M(o,q(w[0]),V(w[0],w[1],w[2])),c[3]=M(c[3],o),f=0;8>f;f++)w[(f+1)%8]=c[f];if(a%16===15)for(f=0;16>f;f++)y[f]=M(y[f],y[(f+9)%16],D(y[(f+1)%16]),H(y[(f+14)%16]))}for(a=0;8>a;a++)w[a]=M(w[a],u[a]),u[a]=w[a];s+=128,e-=128}for(a=0;8>a;a++)i(r,8*a,u[a]);return e}function Q(r,n,e){var t,o=new Uint8Array(64),a=new Uint8Array(256),f=e;for(t=0;64>t;t++)o[t]=Ln[t];for(J(o,n,e),e%=128,t=0;256>t;t++)a[t]=0;for(t=0;e>t;t++)a[t]=n[f-e+t];for(a[e]=128,e=256-128*(112>e?1:0),a[e-9]=0,i(a,e-8,new ln(f/536870912|0,f<<3)),J(o,a,e),t=0;64>t;t++)r[t]=o[t];return 0}function W(r,n){var e=hn(),t=hn(),o=hn(),i=hn(),a=hn(),f=hn(),u=hn(),c=hn(),w=hn();T(e,r[1],r[0]),T(w,n[1],n[0]),Y(e,e,w),K(t,r[0],r[1]),K(w,n[0],n[1]),Y(t,t,w),Y(o,r[3],n[3]),Y(o,o,Un),Y(i,r[2],n[2]),K(i,i,i),T(a,t,e),T(f,i,o),K(u,i,o),K(c,t,e),Y(r[0],a,f),Y(r[1],c,u),Y(r[2],u,f),Y(r[3],a,c)}function $(r,n,e){var t;for(t=0;4>t;t++)E(r[t],n[t],e)}function rn(r,n){var e=hn(),t=hn(),o=hn();C(o,n[2]),Y(e,n[0],o),Y(t,n[1],o),x(r,t),r[31]^=B(e)<<7}function nn(r,n,e){var t,o;for(d(r[0],bn),d(r[1],An),d(r[2],An),d(r[3],bn),o=255;o>=0;--o)t=e[o/8|0]>>(7&o)&1,$(r,n,t),W(n,r),W(r,r),$(r,n,t)}function en(r,n){var e=[hn(),hn(),hn(),hn()];d(e[0],En),d(e[1],xn),d(e[2],An),Y(e[3],En,xn),nn(r,e,n)}function tn(r,n,e){var t,o=new Uint8Array(64),i=[hn(),hn(),hn(),hn()];for(e||gn(n,32),Q(o,n,32),o[0]&=248,o[31]&=127,o[31]|=64,en(i,o),rn(r,i),t=0;32>t;t++)n[t+32]=r[t];return 0}function on(r,n){var e,t,o,i;for(t=63;t>=32;--t){for(e=0,o=t-32,i=t-12;i>o;++o)n[o]+=e-16*n[t]*Cn[o-(t-32)],e=n[o]+128>>8,n[o]-=256*e;n[o]+=e,n[t]=0}for(e=0,o=0;32>o;o++)n[o]+=e-(n[31]>>4)*Cn[o],e=n[o]>>8,n[o]&=255;for(o=0;32>o;o++)n[o]-=e*Cn[o];for(t=0;32>t;t++)n[t+1]+=n[t]>>8,r[t]=255&n[t]}function an(r){var n,e=new Float64Array(64);for(n=0;64>n;n++)e[n]=r[n];for(n=0;64>n;n++)r[n]=0;on(r,e)}function fn(r,n,e,t){var o,i,a=new Uint8Array(64),f=new Uint8Array(64),u=new Uint8Array(64),c=new Float64Array(64),w=[hn(),hn(),hn(),hn()];Q(a,t,32),a[0]&=248,a[31]&=127,a[31]|=64;var y=e+64;for(o=0;e>o;o++)r[64+o]=n[o];for(o=0;32>o;o++)r[32+o]=a[32+o];for(Q(u,r.subarray(32),e+32),an(u),en(w,u),rn(r,w),o=32;64>o;o++)r[o]=t[o];for(Q(f,r,e+64),an(f),o=0;64>o;o++)c[o]=0;for(o=0;32>o;o++)c[o]=u[o];for(o=0;32>o;o++)for(i=0;32>i;i++)c[o+i]+=f[o]*a[i];return on(r.subarray(32),c),y}function un(r,n){var e=hn(),t=hn(),o=hn(),i=hn(),a=hn(),f=hn(),u=hn();return d(r[2],An),S(r[1],n),L(o,r[1]),Y(i,o,dn),T(o,o,r[2]),K(i,r[2],i),L(a,i),L(f,a),Y(u,f,a),Y(e,u,o),Y(e,e,i),R(e,e),Y(e,e,o),Y(e,e,i),Y(e,e,i),Y(r[0],e,i),L(t,r[0]),Y(t,t,i),m(t,o)&&Y(r[0],r[0],mn),L(t,r[0]),Y(t,t,i),m(t,o)?-1:(B(r[0])===n[31]>>7&&T(r[0],bn,r[0]),Y(r[3],r[0],r[1]),0)}function cn(r,n,e,t){var o,i,a=new Uint8Array(32),f=new Uint8Array(64),c=[hn(),hn(),hn(),hn()],w=[hn(),hn(),hn(),hn()];if(i=-1,64>e)return-1;if(un(w,t))return-1;for(o=0;e>o;o++)r[o]=n[o];for(o=0;32>o;o++)r[o+32]=t[o];if(Q(f,r,e),an(f),nn(c,w,f),en(w,n.subarray(32)),W(c,w),rn(a,c),e-=64,u(n,0,a,0)){for(o=0;e>o;o++)r[o]=0;return-1}for(o=0;e>o;o++)r[o]=n[o+64];return i=e}function wn(r,n){if(r.length!==Rn)throw new Error("bad key size");if(n.length!==kn)throw new Error("bad nonce size")}function yn(r,n){if(r.length!==On)throw new Error("bad public key size");if(n.length!==Mn)throw new Error("bad secret key size")}function sn(){for(var r,n={}.toString,e=0;e<arguments.length;e++)if("[object Uint8Array]"!==(r=n.call(arguments[e])))throw new TypeError("unexpected type "+r+", use Uint8Array")}var ln=function(r,n){this.hi=0|r,this.lo=0|n},hn=function(r){var n,e=new Float64Array(16);if(r)for(n=0;n<r.length;n++)e[n]=r[n];return e},gn=function(){throw new Error("no PRNG")},vn=new Uint8Array(16),pn=new Uint8Array(32);pn[0]=9;var bn=hn(),An=hn([1]),_n=hn([56129,1]),dn=hn([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),Un=hn([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),En=hn([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),xn=hn([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),mn=hn([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]),Bn=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]),Sn=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]),Kn=A,Tn=_,Yn=[new ln(1116352408,3609767458),new ln(1899447441,602891725),new ln(3049323471,3964484399),new ln(3921009573,2173295548),new ln(961987163,4081628472),new ln(1508970993,3053834265),new ln(2453635748,2937671579),new ln(2870763221,3664609560),new ln(3624381080,2734883394),new ln(310598401,1164996542),new ln(607225278,1323610764),new ln(1426881987,3590304994),new ln(1925078388,4068182383),new ln(2162078206,991336113),new ln(2614888103,633803317),new ln(3248222580,3479774868),new ln(3835390401,2666613458),new ln(4022224774,944711139),new ln(264347078,2341262773),new ln(604807628,2007800933),new ln(770255983,1495990901),new ln(1249150122,1856431235),new ln(1555081692,3175218132),new ln(1996064986,2198950837),new ln(2554220882,3999719339),new ln(2821834349,766784016),new ln(2952996808,2566594879),new ln(3210313671,3203337956),new ln(3336571891,1034457026),new ln(3584528711,2466948901),new ln(113926993,3758326383),new ln(338241895,168717936),new ln(666307205,1188179964),new ln(773529912,1546045734),new ln(1294757372,1522805485),new ln(1396182291,2643833823),new ln(1695183700,2343527390),new ln(1986661051,1014477480),new ln(2177026350,1206759142),new ln(2456956037,344077627),new ln(2730485921,1290863460),new ln(2820302411,3158454273),new ln(3259730800,3505952657),new ln(3345764771,106217008),new ln(3516065817,3606008344),new ln(3600352804,1432725776),new ln(4094571909,1467031594),new ln(275423344,851169720),new ln(430227734,3100823752),new ln(506948616,1363258195),new ln(659060556,3750685593),new ln(883997877,3785050280),new ln(958139571,3318307427),new ln(1322822218,3812723403),new ln(1537002063,2003034995),new ln(1747873779,3602036899),new ln(1955562222,1575990012),new ln(2024104815,1125592928),new ln(2227730452,2716904306),new ln(2361852424,442776044),new ln(2428436474,593698344),new ln(2756734187,3733110249),new ln(3204031479,2999351573),new ln(3329325298,3815920427),new ln(3391569614,3928383900),new ln(3515267271,566280711),new ln(3940187606,3454069534),new ln(4118630271,4000239992),new ln(116418474,1914138554),new ln(174292421,2731055270),new ln(289380356,3203993006),new ln(460393269,320620315),new ln(685471733,587496836),new ln(852142971,1086792851),new ln(1017036298,365543100),new ln(1126000580,2618297676),new ln(1288033470,3409855158),new ln(1501505948,4234509866),new ln(1607167915,987167468),new ln(1816402316,1246189591)],Ln=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]),Cn=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]),Rn=32,kn=24,zn=32,Pn=16,Fn=32,Nn=32,On=32,Mn=32,Gn=32,In=kn,Zn=zn,jn=Pn,Vn=64,qn=32,Xn=64,Dn=32,Hn=64;r.lowlevel={crypto_core_hsalsa20:y,crypto_stream_xor:g,crypto_stream:h,crypto_stream_salsa20_xor:s,crypto_stream_salsa20:l,crypto_onetimeauth:p,crypto_onetimeauth_verify:b,crypto_verify_16:f,crypto_verify_32:u,crypto_secretbox:A,crypto_secretbox_open:_,crypto_scalarmult:k,crypto_scalarmult_base:z,crypto_box_beforenm:F,crypto_box_afternm:Kn,crypto_box:N,crypto_box_open:O,crypto_box_keypair:P,crypto_hash:Q,crypto_sign:fn,crypto_sign_keypair:tn,crypto_sign_open:cn,crypto_secretbox_KEYBYTES:Rn,crypto_secretbox_NONCEBYTES:kn,crypto_secretbox_ZEROBYTES:zn,crypto_secretbox_BOXZEROBYTES:Pn,crypto_scalarmult_BYTES:Fn,crypto_scalarmult_SCALARBYTES:Nn,crypto_box_PUBLICKEYBYTES:On,crypto_box_SECRETKEYBYTES:Mn,crypto_box_BEFORENMBYTES:Gn,crypto_box_NONCEBYTES:In,crypto_box_ZEROBYTES:Zn,crypto_box_BOXZEROBYTES:jn,crypto_sign_BYTES:Vn,crypto_sign_PUBLICKEYBYTES:qn,crypto_sign_SECRETKEYBYTES:Xn,crypto_sign_SEEDBYTES:Dn,crypto_hash_BYTES:Hn},r.util={},r.util.decodeUTF8=function(r){var n,e=unescape(encodeURIComponent(r)),t=new Uint8Array(e.length);for(n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t},r.util.encodeUTF8=function(r){var n,e=[];for(n=0;n<r.length;n++)e.push(String.fromCharCode(r[n]));return decodeURIComponent(escape(e.join("")))},r.util.encodeBase64=function(r){if("undefined"==typeof btoa)return new Buffer(r).toString("base64");var n,e=[],t=r.length;for(n=0;t>n;n++)e.push(String.fromCharCode(r[n]));return btoa(e.join(""))},r.util.decodeBase64=function(r){if("undefined"==typeof atob)return new Uint8Array(Array.prototype.slice.call(new Buffer(r,"base64"),0));var n,e=atob(r),t=new Uint8Array(e.length);for(n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t},r.randomBytes=function(r){var n=new Uint8Array(r);return gn(n,r),n},r.secretbox=function(r,n,e){sn(r,n,e),wn(e,n);for(var t=new Uint8Array(zn+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+zn]=r[i];return A(o,t,t.length,n,e),o.subarray(Pn)},r.secretbox.open=function(r,n,e){sn(r,n,e),wn(e,n);for(var t=new Uint8Array(Pn+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+Pn]=r[i];return t.length<32?!1:0!==_(o,t,t.length,n,e)?!1:o.subarray(zn)},r.secretbox.keyLength=Rn,r.secretbox.nonceLength=kn,r.secretbox.overheadLength=Pn,r.scalarMult=function(r,n){if(sn(r,n),r.length!==Nn)throw new Error("bad n size");if(n.length!==Fn)throw new Error("bad p size");var e=new Uint8Array(Fn);return k(e,r,n),e},r.scalarMult.base=function(r){if(sn(r),r.length!==Nn)throw new Error("bad n size");var n=new Uint8Array(Fn);return z(n,r),n},r.scalarMult.scalarLength=Nn,r.scalarMult.groupElementLength=Fn,r.box=function(n,e,t,o){var i=r.box.before(t,o);return r.secretbox(n,e,i)},r.box.before=function(r,n){sn(r,n),yn(r,n);var e=new Uint8Array(Gn);return F(e,r,n),e},r.box.after=r.secretbox,r.box.open=function(n,e,t,o){var i=r.box.before(t,o);return r.secretbox.open(n,e,i)},r.box.open.after=r.secretbox.open,r.box.keyPair=function(){var r=new Uint8Array(On),n=new Uint8Array(Mn);return P(r,n),{publicKey:r,secretKey:n}},r.box.keyPair.fromSecretKey=function(r){if(sn(r),r.length!==Mn)throw new Error("bad secret key size");var n=new Uint8Array(On);return z(n,r),{publicKey:n,secretKey:r}},r.box.publicKeyLength=On,r.box.secretKeyLength=Mn,r.box.sharedKeyLength=Gn,r.box.nonceLength=In,r.box.overheadLength=r.secretbox.overheadLength,r.sign=function(r,n){if(sn(r,n),n.length!==Xn)throw new Error("bad secret key size");var e=new Uint8Array(Vn+r.length);return fn(e,r,r.length,n),e},r.sign.open=function(r,n){if(2!==arguments.length)throw new Error("nacl.sign.open accepts 2 arguments; did you mean to use nacl.sign.detached.verify?");if(sn(r,n),n.length!==qn)throw new Error("bad public key size");var e=new Uint8Array(r.length),t=cn(e,r,r.length,n);if(0>t)return null;for(var o=new Uint8Array(t),i=0;i<o.length;i++)o[i]=e[i];return o},r.sign.detached=function(n,e){for(var t=r.sign(n,e),o=new Uint8Array(Vn),i=0;i<o.length;i++)o[i]=t[i];return o},r.sign.detached.verify=function(r,n,e){if(sn(r,n,e),n.length!==Vn)throw new Error("bad signature size");if(e.length!==qn)throw new Error("bad public key size");var t,o=new Uint8Array(Vn+r.length),i=new Uint8Array(Vn+r.length);for(t=0;Vn>t;t++)o[t]=n[t];for(t=0;t<r.length;t++)o[t+Vn]=r[t];return cn(i,o,o.length,e)>=0},r.sign.keyPair=function(){var r=new Uint8Array(qn),n=new Uint8Array(Xn);return tn(r,n),{publicKey:r,secretKey:n}},r.sign.keyPair.fromSecretKey=function(r){if(sn(r),r.length!==Xn)throw new Error("bad secret key size");var n,e=new Uint8Array(qn);for(n=0;32>n;n++)e[n]=r[32+n];return{publicKey:e,secretKey:r}},r.sign.keyPair.fromSeed=function(r){if(sn(r),r.length!==Dn)throw new Error("bad seed size");for(var n=new Uint8Array(qn),e=new Uint8Array(Xn),t=0;32>t;t++)e[t]=r[t];return tn(n,e,!0),{publicKey:n,secretKey:e}},r.sign.publicKeyLength=qn,r.sign.secretKeyLength=Xn,r.sign.seedLength=Dn,r.sign.signatureLength=Vn,r.hash=function(r){sn(r);var n=new Uint8Array(Hn);return Q(n,r,r.length),n},r.hash.hashLength=Hn,r.verify=function(r,n){return sn(r,n),0===r.length||0===n.length?!1:r.length!==n.length?!1:0===a(r,0,n,0,r.length)?!0:!1},r.setPRNG=function(r){gn=r},function(){var n;"undefined"!=typeof window?(window.crypto&&window.crypto.getRandomValues?n=window.crypto:window.msCrypto&&window.msCrypto.getRandomValues&&(n=window.msCrypto),n&&r.setPRNG(function(r,e){var t,o=new Uint8Array(e);for(n.getRandomValues(o),t=0;e>t;t++)r[t]=o[t]})):"undefined"!=typeof require&&(n=require("crypto"),n&&r.setPRNG(function(r,e){var t,o=n.randomBytes(e);for(t=0;e>t;t++)r[t]=o[t]}))}()}("undefined"!=typeof module&&module.exports?module.exports:window.nacl=window.nacl||{});

            //Base58 encode/decode
            //Downloaded from https://gist.githubusercontent.com/diafygi/90a3e80ca1c2793220e5/raw/9b3cffbc22eade44a2ff0d5feb643b8731063f57/index.js
            var to_b58 = function(B,A){var d=[],s="",i,j,c,n;for(i in B){j=0,c=B[i];s+=c||s.length^i?"":1;while(j in d||c){n=d[j];n=n?n*256+c:c;c=n/58|0;d[j]=n%58;j++}}while(j--)s+=A[d[j]];return s};
            var from_b58 = function(S,A){var d=[],b=[],i,j,c,n;for(i in S){j=0,c=A.indexOf(S[i]);if(c<0)return undefined;c||b.length^i?i:b.push(0);while(j in d||c){n=d[j];n=n?n*58+c:c;c=n>>8;d[j]=n%256;j++}}while(j--)b.push(d[j]);return new Uint8Array(b)};
            var B58_MAP = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
        </script>

        <!-- EmailPK Core Library -->
        <script>
            var EmailPK = (function(){
                "use strict";
                //internal key
                var key = {
                    "secretKey": null,
                    "publicKey": null,
                    "salt": null,
                };

                //encode email with Base58 public key
                function _encodeEmail(publicKey, salt){

                    //split the email salt into username and domain
                    var split_email = salt.split("@");
                    var username = split_email[0];
                    var domain = split_email[1];

                    //append the public key to the username and recombine
                    username += "+" + to_b58(publicKey, B58_MAP);
                    return username + "@" + domain;
                }

                //decode email to {publicKey:<Uint8Array>, salt:<String>}
                //returns only salt if no publicKey found in email
                //returns undefined if invalid email
                this.decodeEmail = function(email){

                    //no whitespace allowed
                    if(email.indexOf(" ") !== -1){
                        return undefined;
                    }

                    //split username and domain
                    var split_email = email.split("@");
                    if(split_email.length !== 2){
                        return undefined;
                    }
                    var username = split_email[0];
                    var domain = split_email[1];

                    //username and domain must exist
                    if(!(username.length && domain.length)){
                        return undefined;
                    }

                    //split username into parts
                    var parts = username.split("+");

                    //no public key (means new user, so just return the salt)
                    if(parts.length === 1){
                        var salt = parts[0] + "@" + domain;
                        return {
                            "salt": salt,
                        };
                    }

                    //possibly a public key (always the last part)
                    else{
                        var tmpPub = from_b58(parts[parts.length - 1], B58_MAP);
                        if(tmpPub !== undefined && tmpPub.length === 32){

                            //use all the other username parts in the salt
                            var combined = parts.slice(0, parts.length - 1).join("+");
                            var salt = combined + "@" + domain;
                            return {
                                "publicKey": tmpPub,
                                "salt": salt,
                            };
                        }

                        //last part wasn't a public key, so assume new user
                        var salt = parts.join("+") + "@" + domain;
                        return {
                            "salt": salt,
                        };
                    }
                }

                //default callbacks (do nothing)
                this.onEmailDone = function(error){};
                this.onEncryptDone = function(data, error){};
                this.onDecryptDone = function(data, sender, error){};

                //set keys
                this.setEmail = function(email, passphrase){
                    var tmpUser = this.decodeEmail(email);
                    //invalid email
                    if(tmpUser === undefined){
                        this.onEmailDone("Email doesn't appear valid");
                        return;
                    }
                    //new user
                    else if(tmpUser['publicKey'] === undefined){
                        //passphrases must be over 20 charaters long
                        if(passphrase.length < 20){
                            this.onEmailDone("Passphrase needs 20+ characters");
                            return;
                        }
                    }

                    //generate scrypt secretKey from email salt and hashed passphrase
                    var onScryptDone = this.onEmailDone;
                    var hashed_passphrase = nacl.hash(nacl.util.decodeUTF8(passphrase));
                    var hashed_salt = nacl.hash(nacl.util.decodeUTF8(tmpUser['salt']));
                    scrypt(hashed_salt, hashed_passphrase, 17, 8, 32, 1000, function(b64_bytes){

                        //determine the keyPair and username
                        var scryptKeys = nacl.box.keyPair.fromSecretKey(nacl.util.decodeBase64(b64_bytes));
                        var scryptUser = _encodeEmail(scryptKeys.publicKey, tmpUser['salt']);

                        //if the publicKey was already given, validate it
                        if(tmpUser['publicKey'] !== undefined && email !== scryptUser){
                            onScryptDone("Bad email or passphrase");
                            return;
                        }

                        //set the internal session keys
                        key['secretKey'] = scryptKeys.secretKey;
                        key['publicKey'] = scryptKeys.publicKey;
                        key['salt'] = tmpUser['salt'];

                        //fire the success event
                        onScryptDone();
                    }, "base64");
                };

                //get email with public key
                this.getEmail = function(){
                    if(key['publicKey'] === null || key['salt'] === null){
                        return undefined;
                    }
                    return _encodeEmail(key['publicKey'], key['salt']);
                };

                //encrypt
                this.encrypt = function(text, recipients){

                    //make sure the user's secret key is set
                    if(key['salt'] === null || key['publicKey'] === null || key['secretKey'] === null){
                        this.onEncryptDone(null, "Not logged in");
                        return;
                    }

                    //make sure there are actually recipients
                    if(recipients.length <= 0){
                        this.onEncryptDone(null, "No recipients set");
                        return;
                    }

                    //generate a file encryption key and nonce
                    var textKey = nacl.randomBytes(32);
                    var textNonce = nacl.randomBytes(24);
                    var senderEmailHash = nacl.hash(nacl.util.decodeUTF8(this.getEmail()));
                    var textInfo = new Uint8Array(120);
                    textInfo.set(new Uint8Array(textKey), 0);
                    textInfo.set(new Uint8Array(textNonce), 32);
                    textInfo.set(new Uint8Array(senderEmailHash), 56);

                    //encrypt a userInfo for each recipient in this format:
                    //<header(160 bytes)> = [
                    //    <textInfoNonce(24 bytes)>,
                    //    <textInfoEncrypted(136 bytes)> = [
                    //        <textKey(32 bytes)>,
                    //        <textNonce(24 bytes)>,
                    //        <senderEmailHash(64 bytes)>
                    //    ] (encrypted with recipient.publicKey, textInfoNonce, and sender.secretKey (encryption adds 16 bytes)),
                    //]
                    var headers = [];
                    for(var i = 0; i < recipients.length; i++){

                        //make sure this is a valid username
                        var tmpEmail = this.decodeEmail(recipients[i]);
                        if(tmpEmail === undefined || tmpEmail['publicKey'] === undefined){
                            this.onEncryptDone("Some recipients aren't valid");
                            return;
                        }

                        //encrypt the textKey/textNonce payload
                        var textInfoNonce = nacl.randomBytes(24);
                        var textInfoEncrypted = nacl.box(
                            textInfo,
                            textInfoNonce,
                            tmpEmail['publicKey'],
                            key['secretKey']);

                        //build the header packet
                        var tmpHeader = new Uint8Array(160);
                        tmpHeader.set(new Uint8Array(textInfoNonce), 0);
                        tmpHeader.set(new Uint8Array(textInfoEncrypted), 24);

                        headers.push(tmpHeader);
                    }

                    //encrypt the text
                    var encrypted = nacl.secretbox(
                        nacl.util.decodeUTF8(text),
                        textNonce,
                        textKey);

                    //compose the final message, concated in this order:
                    //[
                    //  <senderPublicKey(32 bytes)>,
                    //  <header(160 bytes)>,
                    //  <header(160 bytes)>,
                    //  ....
                    //  <encryptedBody(variable bytes)>
                    //]
                    var rawMessage = new Uint8Array(32 + headers.length * 160 + encrypted.length);
                    rawMessage.set(new Uint8Array(tmpEmail['publicKey']), 0);
                    for(var i = 0; i < headers.length; i++){
                        rawMessage.set(new Uint8Array(headers[i]), 32 + i * 160);
                    }
                    rawMessage.set(new Uint8Array(encrypted), 32 + i * 160);

                    //base58 encode the message
                    this.onEncryptDone(to_b58(rawMessage, B58_MAP));
                    return;
                };

                //decrypt
                this.decrypt = function(message, sender){
                    var raw = from_b58(message, B58_MAP);
                    var textKey, textNonce;

                    //get the sender's public key
                    var senderPublicKey = raw.subarray(0, 32);
                    if(senderPublicKey.length !== 32){
                        this.onDecryptDone(null, "Couldn't decrypt message");
                        return;
                    }

                    //validate sender matches the public key
                    var tmpSender = this.decodeEmail(sender);
                    if(tmpSender === undefined
                        || tmpSender['publicKey'] === undefined
                        || to_b58(tmpSender['publicKey'], B58_MAP) !== to_b58(senderPublicKey, B58_MAP)){

                        this.onDecryptDone(null, "Couldn't validate sender");
                        return;
                    }

                    //try to decrypt one of the headers
                    for(var i = 32; i < raw.length; i+=160){
                        //if textKey/textNonce are set, try to decrypt the file
                        if(textKey !== undefined && textNonce !== undefined){
                            var text = nacl.secretbox.open(
                                raw.subarray(i, raw.length),
                                textNonce,
                                textKey);
                            //text successfully decrypted, return the text
                            if(text !== false){
                                this.onDecryptDone(nacl.util.encodeUTF8(text));
                                return;
                            }
                        }

                        //skip if not enough remaining in file for a header
                        if(raw.length - i < 160){
                            continue;
                        }

                        //try to decrypt the header
                        var textInfo = nacl.box.open(
                            raw.subarray(i + 24, i + 160), //textInfoEncrypted
                            raw.subarray(i, i + 24),           //textInfoNonce
                            senderPublicKey,
                            key['secretKey']);

                        //header successfully decrypted
                        if(textInfo !== false){

                            //authenticate sender email hash
                            var tmpHash = nacl.hash(nacl.util.decodeUTF8(sender));
                            if(to_b58(tmpHash, B58_MAP) !== to_b58(textInfo.subarray(56, 120), B58_MAP)){
                                this.onDecryptDone(null, "Couldn't authenticate sender");
                                return;
                            }

                            //set the textKey/textNonce
                            textNonce = textInfo.subarray(32, 56);
                            textKey = textInfo.subarray(0, 32);
                        }
                    }

                    //went through the whole message without being able to decrypt it
                    this.onDecryptDone(null, "Couldn't decrypt message");
                    return;
                };
            });
        </script>

        <!-- User Interface CSS -->
        <style>
            body{font-family:sans-serif;}
            body,div,h1,h2,h3,h4,ul,li,span,div,a,textarea,label,select,input,button{font-size:14px;font-weight:normal;margin:0;padding:0;box-sizing:border-box;}
            a{text-decoration:none;}
            a:hover{text-decoration:underline;}
            button{font-size:16px;padding:2px;}
            .error{color:#ff0000;}
            #header{padding:5px;}
            #header h1{display:inline-block;font-size:24px;font-weight:bold;padding:0px 0px 10px 10px;}
            #header h4{display:inline-block;font-size:18px;padding:0px 0px 0px 10px;}
            #header h4 a{color:#ffffff;}
            #header{padding-bottom:20px;color:#ffffff;background-color:#6786f8;}
            #user{text-align:right;padding-bottom:5px;min-height:26px;width:100%;font-size:12px;word-wrap:break-word;}
            #user-email{width:100%;max-width:300px;font-size:12px;display:inline-block;}
            #user a{font-size:10px;color:#ffffff;}
            #no-user{text-align:right;padding-bottom:5px;width:100%;font-size:12px;min-height:26px;word-wrap:break-word;}
            #announcement{background-color:#ff0000;padding:5px 0px;text-align:center;color:#ffffff;font-size:12px;font-weight:bold;}
            #toolbar span{display:inline-block;margin:5px 0px 5px 5px;border-radius:5px;border:3px solid #ffffff;}
            #content-wrapper{text-align:center;}
            #content{display:inline-block;text-align:left;max-width:600px;width:100%;padding:0px 5px;}
            #content > div{text-align:center;}
            #content textarea{width:100%;height:275px;border:1px solid #555555;padding:7px;}
            div#hint{font-size:16px;padding:10px 0px;text-align:left;word-wrap:break-word;}
            #read-buttons-wrapper button{margin:10px;}
            #decrypt-overlay-background{opacity:0.9;display:inline-block;max-width:590px;width:100%;height:275px;background-color:#cccccc;position:absolute;z-index:1;}
            #decrypt-overlay-wrapper{display:inline-block;max-width:590px;width:100%;height:275px;position:absolute;z-index:1;}
            #decrypt-overlay{text-align:left;padding:10px;}
            #decrypt-hint{text-align:center;font-size:18px;padding:20px 0px;}
            #decrypt-overlay > div{margin:10px 0px;}
            #decrypt-overlay label{display:inline-block;width:100%;max-width:165px;}
            #decrypt-overlay input{display:inline-block;width:100%;max-width:390px;padding:2px 1px 1px 4px;font-size:12px;border:1px solid #555555;background-color:#ffffff;}
            #decrypt-emails{display:inline-block;width:100%;max-width:390px;border:1px solid #555555;background-color:#ffffff;text-overflow:ellipsis;}
            #decrypt-error{text-align:center;}
            #decrypt-now-wrapper{text-align:center;}
            #decrypt-now-wrapper button{margin:10px;}
            #encrypt-wrapper{text-align:center;}
            #encrypt{display:inline-block;text-align:left;max-width:600px;width:100%;padding:0px 5px;}
            #encrypt-hint{font-size:16px;text-align:center;}
            #encrypt label{display:inline-block;width:100%;max-width:140px;}
            #encrypt > div{margin:10px 0px;}
            .encrypt-recipient-wrapper label{vertical-align:top;}
            .encrypt-recipient-wrapper textarea{width:100%;max-width:445px;height:44px;border:1px solid #555555;padding:1px;font-size:12px;}
            #encrypt-show-cc{font-size:12px;}
            #encrypt-text{width:100%;height:275px;border:1px solid #555555;padding:7px;}
            #encrypt input{width:100%;max-width:445px;border:1px solid #555555;padding:2px 1px 1px 4px;font-size:12px;}
            #encrypt-error{text-align:center;}
            #encrypt-button-wrapper{text-align:right;padding:0px 0px 0px 0px;}
            #encrypt-button-wrapper button{display:inline-block;vertical-align:top;margin-bottom:5px;height:30px;}
            #send-wrapper{display:inline-block;width:100%;max-width:260px;min-height:1px;text-align:left;vertical-align:top;margin-left:5px;}
            #send-selector{display:inline-block;position:absolute;list-style:none;width:100%;max-width:260px;z-index:1;}
            #send-selector li{text-align:left;display:none;}
            #send-selector:hover li{display:block;}
            #send-selector li:first-child a{border-top:1px solid #888888;}
            #send-selector li a{display:block;padding:5px;height:30px;border-bottom:1px solid #888888;border-left:1px solid #888888;border-right:1px solid #888888;background-color:#eeeeee;color:#000000;}
            #send-toggle{display:inline-block;position:absolute;left:230px;top:0px;z-index:2;text-align:center;border:1px solid #888888;background-color:#eeeeee;color:#000000;width:30px;height:30px;padding-top:6px;}
            #send-disabled{display:inline-block;width:100%;max-width:260px;height:30px;color:#888888;border:1px solid #AAA;background-color:#eeeeee;padding:5px;}
            #send-disabled-toggle{float:right;text-align:center;margin:-6px -6px 0px 0px;border:1px solid #aaaaaa;background-color:#eeeeee;width:30px;height:30px;padding-top:6px;}
            #send-toggle:hover{text-decoration:none;}
            #footer{font-size:12px;margin:100px 0px 40px 0px;text-align:center;}
            #footer a{font-size:12px;}
        </style>
    </head>
    <body>

        <!-- User Interface HTML -->
        <div id="header">
            <div id="user" style="display:none;">
                Your email:
                <input id="user-email" value="diafygi+1o2i3u59uefoi329fjseawf09wjaw@gmail.com"/>
                <a id="forget" href="#">forget</a>
            </div>
            <div id="no-user">
                No email set.
            </div>
            <h1>EmailPK</h1>
            <h4>
                Instant encrypted email
                [<a href="https://github.com/diafygi/emailpk" target="_blank">docs</a>]
            </h4>
        </div>
        <div id="announcement">
            NOTE: THIS IS A PROOF OF CONCEPT. DO NOT USE FOR REAL SECRETS!
        </div>
        <div id="toolbar">
            <span id="compose-button-wrapper">
                <button id="compose">Compose New</button>
            </span>
            <span id="read-button-wrapper">
                <button id="read">Read Existing</button>
            </span>
        </div>
        <div id="content-wrapper" style="display:none;">
            <div id="content">
                <div id="hint">Paste your encrypted link below:</div>
                <div id="decrypt-overlay-background"></div>
                <div id="decrypt-overlay-wrapper">
                    <div id="decrypt-overlay">
                        <div id="decrypt-hint">This message is encrypted.</div>
                        <div id="decrypt-emails-wrapper">
                            <label for="decrypt-emails">Select your email:</label>
                            <select id="decrypt-emails">
                                <option value="diafygi+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com">diafygi+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com</option>
                                <option value="diafygi+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com">diafygi+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com</option>
                                <option value="other">Manually enter another email.</option>
                            </select>
                        </div>
                        <div id="decrypt-manual-wrapper">
                            <label for="decrypt-manual">Other email:</label>
                            <input id="decrypt-manual" placeholder="joe+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com"/>
                        </div>
                        <div>
                            <label for="decrypt-passphrase">Type your passphrase:</label>
                            <input id="decrypt-passphrase" type="password" placeholder="******"/>
                        </div>
                        <div id="decrypt-error" class="error"></div>
                        <div id="decrypt-now-wrapper">
                            <button id="decrypt-now">Decrypt</button>
                            <button id="decrypt-now-cancel">Cancel</button>
                        </div>
                    </div>
                </div>
                <div>
                    <textarea id="text"></textarea>
                    <input id="text-backup" type="hidden"/>
                    <input id="text-encrypted" type="hidden"/>
                </div>
                <div id="read-buttons-wrapper">
                    <button id="decrypt-button">Decrypt</button>
                    <button id="reply-button">Reply</button>
                    <button id="reply-all-button">Reply All</button>
                    <button id="decrypt-cancel">Cancel</button>
                </div>
            </div>
        </div>
        <div id="encrypt-wrapper">
            <div id="encrypt">
                <div id="encrypt-hint">Type your message below.</div>
                <div>
                    <label for="encrypt-email">From (your email):</label>
                    <input id="encrypt-email" placeholder="joe@gmail.com"/>
                </div>
                <div class="encrypt-recipient-wrapper">
                    <label for="encrypt-to" title="Can be one or multiple comma separated emails">
                        Send message to:<br/>
                        <a id="encrypt-show-cc" href="#">add CC or BCC</a>
                    </label>
                    <textarea id="encrypt-to" placeholder="joe+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com, bob+ZqtrSPywFZ4ip4MUUXsZ7KneFHpXHstYnGCssTKujt9V@gmail.com"></textarea>
                </div>
                <div id="encrypt-cc-wrapper" class="encrypt-recipient-wrapper" style="display:none;">
                    <label for="encrypt-c" title="Can be one or multiple comma separated emails">CC:</label>
                    <textarea id="encrypt-cc" placeholder="joe+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com, bob+ZqtrSPywFZ4ip4MUUXsZ7KneFHpXHstYnGCssTKujt9V@gmail.com"></textarea>
                </div>
                <div id="encrypt-bcc-wrapper" class="encrypt-recipient-wrapper" style="display:none;">
                    <label for="encrypt-bcc" title="Can be one or multiple comma separated emails">BCC:</label>
                    <textarea id="encrypt-bcc" placeholder="joe+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com, bob+ZqtrSPywFZ4ip4MUUXsZ7KneFHpXHstYnGCssTKujt9V@gmail.com"></textarea>
                </div>
                <input id="encrypt-subject" type="hidden"/>
                <textarea id="encrypt-text" placeholder="Type message here"></textarea>
                <div id="encrypt-passphrase-hint-wrapper">
                    <span>If you want read encrypted replies (optional but recommended):</span>
                </div>
                <div id="encrypt-passphrase-wrapper">
                    <label for="encrypt-passphrase">Strong passphrase:</label>
                    <input id="encrypt-passphrase" type="password" placeholder="20 or more characters"/>
                </div>
                <div id="encrypt-error" class="error">&nbsp;</div>
                <div id="encrypt-button-wrapper">
                    <button id="encrypt-button">Encrypt</button>
                    <div id="send-wrapper">
                        <div id="send-disabled">
                            Send via...
                            <div id="send-disabled-toggle">v</div>
                        </div>
                        <ul id="send-selector" style="display:none;">
                            <li style="display:block;"><a id="send-gmail" href="#" target="_blank">Send via Gmail</a></li>
                            <li><a id="send-yahoo" href="#" target="_blank">Send via Yahoo</a></li>
                            <li><a id="send-outlook" href="#" target="_blank">Send via Outlook/Hotmail/Live</a></li>
                            <li><a id="send-generic" href="#" target="_blank">Send via Other (using mailto)</a></li>
                            <a id="send-toggle" href="#">+</a>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer">
            Documentation and source code:
            <a href="https://github.com/diafygi/emailpk" target="_blank">
                https://github.com/diafygi/emailpk
            </a>
        </div>

        <!-- User Interface Javascript -->
        <script>
            var EPK = new EmailPK();

            //re-fill user email with the current email
            function repopulate_email(e){
                if(e !== undefined) e.preventDefault();
                document.getElementById("user-email").value = EPK.getEmail() || "";
            }

            //update the user setting to show the email or not
            function refresh_user(){
                var email = EPK.getEmail()
                //show the email in the top right
                if(email !== undefined){
                    document.getElementById("user-email").value = email;
                    document.getElementById("user").style.display = "block";
                    document.getElementById("no-user").style.display = "none";
                }
                //clear and hide the user email
                else{
                    document.getElementById("user-email").value = "";
                    document.getElementById("user").style.display = "none";
                    document.getElementById("no-user").style.display = "block";
                }
            }

            //forget a user
            function click_forget(e){
                if(e !== undefined) e.preventDefault();
                EPK = new EmailPK();
                refresh_user();
            }

            //reset to compose new message
            function click_compose(e, from_email, to_emails, cc_emails, subject, msg){
                if(e !== undefined) e.preventDefault();

                //hide decrypt panel
                document.getElementById("content-wrapper").style.display = "none";
                document.getElementById("read-button-wrapper").style.border = "3px solid #ffffff";

                //fill out encrypt fields
                document.getElementById("encrypt-email").value = EPK.getEmail() || from_email || "";
                document.getElementById("encrypt-to").value = to_emails || "";
                document.getElementById("encrypt-cc").value = cc_emails || "";
                document.getElementById("encrypt-bcc").value = "";
                document.getElementById("encrypt-subject").value = subject || "";
                document.getElementById("encrypt-text").value = msg || "";

                //show the cc/bcc fields if there are any
                if(document.getElementById("encrypt-cc").value !== ""){
                    document.getElementById("encrypt-show-cc").style.display = "none";
                    document.getElementById("encrypt-cc-wrapper").style.display = "block";
                    document.getElementById("encrypt-bcc-wrapper").style.display = "block";
                }
                else{
                    document.getElementById("encrypt-show-cc").style.display = "inline ";
                    document.getElementById("encrypt-cc-wrapper").style.display = "none";
                    document.getElementById("encrypt-bcc-wrapper").style.display = "none";
                }

                //show the encrypt panel
                document.getElementById("encrypt-button").innerHTML = "Encrypt";
                document.getElementById("encrypt-button").disabled = null;
                document.getElementById("send-disabled").style.display = "inline-block";
                document.getElementById("send-selector").style.display = "none";
                document.getElementById("encrypt-wrapper").style.display = "block";
                document.getElementById("compose-button-wrapper").style.border = "3px solid #6786f8";
                blur_encrypt_email();
            }

            //re-fill text area with the current message
            function repopulate_text(e){
                if(e !== undefined) e.preventDefault();
                document.getElementById("text").value = document.getElementById("text-backup").value;
            }

            //reset to read an existing message
            function click_read(e, msg, error){
                if(e !== undefined) e.preventDefault();

                //hide encrypt panel
                document.getElementById("encrypt-wrapper").style.display = "none";
                document.getElementById("compose-button-wrapper").style.border = "3px solid #ffffff";

                //hide the decrypt overlay
                document.getElementById("decrypt-overlay-wrapper").style.display = "none";
                document.getElementById("decrypt-overlay-background").style.display = "none";

                //hide the reply/reply-all buttons and show the decrypt button
                document.getElementById("decrypt-button").style.display = "inline-block";
                document.getElementById("decrypt-button").innerHTML = "Decrypt";
                document.getElementById("decrypt-button").disabled = null;
                document.getElementById("decrypt-cancel").disabled = null;
                document.getElementById("reply-button").style.display = "none";
                document.getElementById("reply-all-button").style.display = "none";

                //fill out decrypt fields
                document.getElementById("text").value = msg || "";
                document.getElementById("text-backup").value = msg || "";

                //attempt to decrypt the message
                if(msg !== undefined && msg !== "" && error === undefined){
                    document.getElementById("hint").innerHTML = "Attempting to decrypt...";
                    click_decrypt();
                }
                //error state
                else if(error !== undefined){
                    document.getElementById("text").onblur = null;
                    document.getElementById("hint").innerHTML = error;
                    document.getElementById("hint").className = "error";
                    document.getElementById("decrypt-button").disabled = null;
                    document.getElementById("decrypt-cancel").disabled = null;
                }
                //blank state
                else{
                    document.getElementById("text").onblur = null;
                    document.getElementById("hint").innerHTML = "Paste your encrypted link below:";
                    document.getElementById("hint").className = "";
                    document.getElementById("decrypt-button").disabled = null;
                    document.getElementById("decrypt-cancel").disabled = null;
                }

                //show the read panel
                document.getElementById("content-wrapper").style.display = "block";
                document.getElementById("read-button-wrapper").style.border = "3px solid #6786f8";
            }

            //show the decrypt overlay
            function show_decrypt_overlay(recipients, error, selected, other){
                //set the error field or default
                if(error !== undefined){
                    document.getElementById("decrypt-hint").innerHTML = error;
                    document.getElementById("decrypt-hint").className = "error";
                }
                else{
                    document.getElementById("decrypt-hint").innerHTML = "This message is encrypted.";
                    document.getElementById("decrypt-hint").className = "";
                }

                //populate the dropdown field
                document.getElementById("decrypt-emails").innerHTML = "";
                for(var i = 0; i < recipients.length; i++){
                    //skip other field since it's added at the end anyway
                    if(recipients[i] === "other"){
                        continue;
                    }
                    //create the dropdown options
                    var option = document.createElement("option");
                    option.value = recipients[i];
                    option.appendChild(document.createTextNode(recipients[i]));
                    //pre-select an option if provided
                    if(selected !== undefined && selected === i){
                        option.selected = selected;
                    }
                    //insert the option into the dropdown
                    document.getElementById("decrypt-emails").appendChild(option);
                }

                //add the manual entry option
                var option = document.createElement("option");
                option.value = "other";
                option.appendChild(document.createTextNode("Manually enter another email."));
                document.getElementById("decrypt-emails").appendChild(option);

                //show the manual entry option if no recipients
                document.getElementById("decrypt-manual").value = other || "";
                if(!recipients.length){
                    document.getElementById("decrypt-emails-wrapper").style.display = "none";
                    document.getElementById("decrypt-manual-wrapper").style.display = "block";
                }
                else{
                    document.getElementById("decrypt-emails-wrapper").style.display = "block";
                    document.getElementById("decrypt-manual-wrapper").style.display = "none";
                }

                //reset the passphrase field
                document.getElementById("decrypt-passphrase").value = "";

                //show the overlay wrapper and reset the decrypt now button
                document.getElementById("decrypt-now").innerHTML = "Decrypt";
                document.getElementById("decrypt-now").disabled = null;
                document.getElementById("decrypt-now-cancel").disabled = null;
                document.getElementById("decrypt-overlay-wrapper").style.display = "inline-block";
                document.getElementById("decrypt-overlay-background").style.display = "inline-block";
            }

            //when you change the decrypt overlay email dropdown to other, show the other input field
            function change_decrypt_emails(e){
                if(e !== undefined) e.preventDefault();
                var dropdown = document.getElementById("decrypt-emails");
                if(dropdown.options[dropdown.selectedIndex].value === "other"){
                    document.getElementById("decrypt-manual-wrapper").style.display = "block";
                }
                else{
                    document.getElementById("decrypt-manual-wrapper").style.display = "none";
                }
            }

            //decrypt a pasted message
            function click_decrypt_now(e){
                if(e !== undefined) e.preventDefault();

                //disable the decrypt now button
                document.getElementById("decrypt-now").innerHTML = "Verifying...";
                document.getElementById("decrypt-now").disabled = "disabled";
                document.getElementById("decrypt-now-cancel").disabled = "disabled";

                //get the list of recipients (minus "other")
                var dropdown = document.getElementById("decrypt-emails");
                var recipients = [];
                for(var i = 0; i < dropdown.options.length - 1; i++){
                    recipients.push(dropdown.options[i].value);
                }

                //get the selected email and passpharase
                var email = dropdown.options[dropdown.selectedIndex].value;
                if(email === "other"){
                    email = document.getElementById("decrypt-manual").value;
                }
                var passphrase = document.getElementById("decrypt-passphrase").value;

                //verify the user
                if(EPK.decodeEmail(email) === undefined){
                    show_decrypt_overlay(
                        recipients,
                        "That email doesn't appear to be valid for decryption",
                        dropdown.selectedIndex,
                        document.getElementById("decrypt-manual").value);
                    return;
                }
                EPK.onEmailDone = function(error){
                    //error response
                    if(error !== undefined){
                        show_decrypt_overlay(
                            recipients,
                            "Couldn't verify email/passphrase combination",
                            dropdown.selectedIndex,
                            document.getElementById("decrypt-manual").value);
                        return;
                    }

                    //successful login, try to decrypt the message
                    refresh_user();
                    click_decrypt();
                };
                EPK.setEmail(email, passphrase);
            }

            //decrypt a pasted message
            function click_decrypt_now_cancel(e){
                click_read(undefined, document.getElementById("text").value, "Cancelled decryption");
            }

            //parse a raw message link for parameters
            function parse_params(txt){
                //no or extra "?"s raises an error
                var split_txt = txt.split("?");
                if(split_txt.length !== 2){
                    return "Couldn't parse the link. Is it all there?";
                }

                //split into parameters
                var params = {};
                var params_list = split_txt[1].replace(/\s/g, "").split("&");
                for(var i = 0; i < params_list.length; i++){
                    var param_split = params_list[i].split("=");
                    if(param_split.length !== 2){
                        return "Couldn't parse the link. Is it all there?";
                    }
                    params[param_split[0]] = decodeURIComponent(param_split[1]);
                }

                //make sure there's a msg field
                if(params["msg"] === undefined){
                    return "Couldn't parse the link. Is it all there?";
                }

                //try to parse to/cc
                params['to'] = params['to'] !== undefined ? params['to'].split(",") : [];
                params['cc'] = params['cc'] !== undefined ? params['cc'].split(",") : [];

                //always set a from value
                params['from'] = params['from'] !== undefined ? params['from'] : "";

                return params;
            }

            //decrypt a pasted message
            function click_decrypt(e){
                if(e !== undefined) e.preventDefault();

                //hide the overlay
                document.getElementById("decrypt-overlay-wrapper").style.display = "none";
                document.getElementById("decrypt-overlay-background").style.display = "none";

                //disable the decrypt button
                document.getElementById("decrypt-button").innerHTML = "Decrypting...";
                document.getElementById("decrypt-button").disabled = "disabled";
                document.getElementById("decrypt-cancel").disabled = "disabled";

                //parse the parameters
                var txt = document.getElementById("text").value;
                document.getElementById("text-backup").value = txt;
                var params = parse_params(txt);

                //handle any parsing errors (sent back as strings)
                if(typeof(params) === "string"){
                    click_read(undefined, txt, params);
                    return;
                }

                //show the overlay if not logged in
                if(!EPK.getEmail()){
                    show_decrypt_overlay(params["to"].concat(params["cc"]));
                    return;
                }

                //try to decrypt
                EPK.onDecryptDone = function(msg, error){
                    //decryption error
                    if(error !== undefined){
                        show_decrypt_overlay(params["to"].concat(params["cc"]), error);
                        return;
                    }

                    //show the decrypted message
                    document.getElementById("text-encrypted").value = document.getElementById("text-backup").value;
                    document.getElementById("text").value = msg;
                    document.getElementById("text-backup").value = msg;
                    document.getElementById("text").onblur = repopulate_text;

                    //show the sender's email
                    document.getElementById("hint").innerHTML = "";
                    document.getElementById("hint").appendChild(document.createTextNode(
                        "Decrypted with verified sender (" + params['from'] + ")."));
                    document.getElementById("hint").className = "";

                    //show the reply and reply-all buttons
                    document.getElementById("decrypt-button").style.display = "none";
                    document.getElementById("decrypt-cancel").style.display = "none";
                    document.getElementById("reply-button").style.display = "inline-block";
                    document.getElementById("reply-all-button").style.display = "inline-block";
                };
                EPK.decrypt(params["msg"], params['from']);
            }

            //reply to a message
            function click_reply(e){
                if(e !== undefined) e.preventDefault();
                //parse the message parameters (ignore any errors)
                var params = parse_params(document.getElementById("text-encrypted").value);
                if(typeof(params) === "string"){
                    params = {};
                }

                //open the compose window
                click_compose(undefined, undefined, params['from'], undefined, params['subject']);

                //un-hide the decrypt panel (since it was hidden by the compose click)
                document.getElementById("content-wrapper").style.display = "block";
                document.getElementById("read-button-wrapper").style.border = "3px solid #6786f8";
                document.getElementById("compose-button-wrapper").style.border = "3px solid #ffffff";
            }

            //reply-all to a message
            function click_reply_all(e){
                if(e !== undefined) e.preventDefault();
                //parse the message parameters
                var params = parse_params(document.getElementById("text-encrypted").value);
                if(typeof(params) === "string"){
                    params = {};
                    return;
                }

                //restructure to/cc lists into comma separated strings (skip your own email)
                var cc_list = params['to'].concat(params['cc']);
                var cc_cleared = [];
                for(var i = 0; i < cc_list.length; i++){
                    if(cc_list[i] !== EPK.getEmail()){
                        cc_cleared.push(cc_list[i]);
                    }
                }
                var cc_emails = cc_cleared.length ? cc_cleared.join(",") : undefined;

                //open the compose window
                click_compose(undefined, undefined, params['from'], cc_emails, params['subject']);

                //un-hide the decrypt panel (since it was hidden by the compose click)
                document.getElementById("content-wrapper").style.display = "block";
                document.getElementById("read-button-wrapper").style.border = "3px solid #6786f8";
                document.getElementById("compose-button-wrapper").style.border = "3px solid #ffffff";
            }

            //add cc/bcc recipients
            function click_add_cc(e){
                if(e !== undefined) e.preventDefault();
                document.getElementById("encrypt-show-cc").style.display = "none";
                document.getElementById("encrypt-cc-wrapper").style.display = "block";
                document.getElementById("encrypt-bcc-wrapper").style.display = "block";
            }

            //update the password field if there's a change to the from field
            function blur_encrypt_email(e){
                if(e !== undefined) e.preventDefault();

                //if the user is logged in and the from field matches, hide the password field
                var user_email = EPK.getEmail();
                if(user_email !== undefined && user_email === document.getElementById("encrypt-email").value){
                    document.getElementById("encrypt-passphrase-hint-wrapper").style.display = "none";
                    document.getElementById("encrypt-passphrase-wrapper").style.display = "none";
                    document.getElementById("encrypt-passphrase").value = "";
                }
                //the user isn't logged in or the from field doesn't match
                else{
                    document.getElementById("encrypt-passphrase-hint-wrapper").style.display = "block";
                    document.getElementById("encrypt-passphrase-wrapper").style.display = "block";
                    document.getElementById("encrypt-passphrase").value = "";
                }
            }

            //encrypt a message
            function click_encrypt(e){
                if(e !== undefined) e.preventDefault();

                //show encrypting status
                document.getElementById("encrypt-error").innerHTML = "&nbsp;";
                document.getElementById("encrypt-button").innerHTML = "Encrypting...";
                document.getElementById("encrypt-button").disabled = "disabled";

                //compile all the fields
                var from = document.getElementById("encrypt-email").value;
                var to = document.getElementById("encrypt-to").value.replace(/\s/g, "");
                var cc = document.getElementById("encrypt-cc").value.replace(/\s/g, "");
                var bcc = document.getElementById("encrypt-bcc").value.replace(/\s/g, "");
                var msg = document.getElementById("encrypt-text").value;
                var passphrase = document.getElementById("encrypt-passphrase").value;

                //generate a subject if none exists
                var subject = document.getElementById("encrypt-subject").value;
                if(subject === ""){
                    subject = to_b58(nacl.randomBytes(16), B58_MAP);
                }
                //mark replies if not already marked
                else if(!subject.match(/^Re: /)){
                    subject = "Re: " + subject;
                }

                //handle encryption completion or error
                function _encrypt_done(data, error){
                    //encryption error
                    if(error !== undefined){
                        document.getElementById("encrypt-error").innerHTML = error;
                        document.getElementById("encrypt-button").innerHTML = "Encrypt";
                        document.getElementById("encrypt-button").disabled = null;
                    }
                    //successful encryption
                    else{
                        //update the textarea with the encrypted message
                        var cur_path = window.location.href.split("?")[0];
                        var link = cur_path +
                            "?" + "from=" + encodeURIComponent(from) +
                            "&" + "subject=" + encodeURIComponent(subject) +
                            "&" + "msg=" + encodeURIComponent(data);
                        if(to !== ""){
                            link += "&" + "to=" + encodeURIComponent(to);
                        }
                        if(cc !== ""){
                            link += "&" + "cc=" + encodeURIComponent(cc);
                        }

                        //invite template special case
                        if(data === "invite"){
                            var final = "I'd like to send you an encrypted email. Click here to reply:\n\n" + link;
                        }
                        //normal template
                        else{
                            var final = "This message is encrypted. Click here to read or reply:\n\n" + link;
                        }
                        document.getElementById("encrypt-text").value = final;

                        //keep the encrypt button disabled
                        document.getElementById("encrypt-error").innerHTML = "&nbsp;";
                        document.getElementById("encrypt-button").innerHTML = "Encrypted";
                        document.getElementById("encrypt-button").disabled = "disabled";

                        //enable the send links
                        document.getElementById("send-disabled").style.display = "none";
                        document.getElementById("send-selector").style.display = "inline-block";

                        /**********************/
                        /***** Email Links ****/
                        /**********************/

                        //Gmail
                        var gmail_dest = "https://mail.google.com/mail/?view=cm&fs=1" +
                            "&to=" + encodeURIComponent(to) +
                            "&su=" + encodeURIComponent(subject) +
                            "&body=" + encodeURIComponent(final);
                        if(document.getElementById("encrypt-cc").value !== ""){
                            gmail_dest += "&cc=" + encodeURIComponent(cc);
                        }
                        if(document.getElementById("encrypt-bcc").value !== ""){
                            gmail_dest += "&bcc=" + encodeURIComponent(bcc);
                        }
                        document.getElementById("send-gmail").href = gmail_dest;

                        //Yahoo
                        var yahoo_dest = "http://compose.mail.yahoo.com/" +
                            "?to=" + encodeURIComponent(to) +
                            "&subj=" + encodeURIComponent(subject) +
                            "&body=" + encodeURIComponent(final);
                        if(cc !== ""){
                            yahoo_dest += "&cc=" + encodeURIComponent(cc);
                        }
                        if(bcc !== ""){
                            yahoo_dest += "&bcc=" + encodeURIComponent(bcc);
                        }
                        document.getElementById("send-yahoo").href = yahoo_dest;

                        //Outlook
                        var outlook_dest = "https://mail.live.com/default.aspx?rru=compose" +
                            "&to=" + encodeURIComponent(to) +
                            "&subject=" + encodeURIComponent(subject) +
                            "&body=" + encodeURIComponent(final);
                        if(cc !== ""){
                            outlook_dest += "&cc=" + encodeURIComponent(cc);
                        }
                        if(bcc !== ""){
                            outlook_dest += "&bcc=" + encodeURIComponent(bcc);
                        }
                        document.getElementById("send-outlook").href = outlook_dest;


                        //Generic
                        var generic_dest = "mailto:" + encodeURIComponent(to) +
                            "?subject=" + encodeURIComponent(subject) +
                            "&body=" + encodeURIComponent(final);
                        if(cc !== ""){
                            generic_dest += "&cc=" + encodeURIComponent(cc);
                        }
                        if(bcc !== ""){
                            generic_dest += "&bcc=" + encodeURIComponent(bcc);
                        }
                        document.getElementById("send-generic").href = generic_dest;
                    }
                }

                //error if no recipients
                if(to + cc + bcc === ""){
                    document.getElementById("encrypt-error").innerHTML = "You need to have at least one recipient (you can put your own email if you want).";
                    document.getElementById("encrypt-button").innerHTML = "Encrypt";
                    document.getElementById("encrypt-button").disabled = null;
                    return;
                }

                //compile valid recipients
                var recipients = to.split(",").concat(cc.split(",").concat(bcc.split(",")));
                var invalid_recipients = [];
                var valid_recipients = [];
                for(var i = 0; i < recipients.length; i++){
                    //skip blanks
                    if(recipients[i] === ""){
                        continue;
                    }
                    //is this an to which email you can encrypt?
                    var valid = EPK.decodeEmail(recipients[i]);
                    if(valid === undefined || valid['publicKey'] === undefined){
                        invalid_recipients.push(recipients[i]);
                    }
                    else{
                        valid_recipients.push(recipients[i]);
                    }
                }

                //send invites if no valid recipients
                if(invalid_recipients.length && !valid_recipients.length){
                    if(confirm("Can't encrypt for your recipients. Do you want to send them an invite?")){
                        //register user if not already registered
                        if(!EPK.getEmail()){
                            //random passphrase if the user didn't enter one
                            if(passphrase === ""){
                                passphrase = to_b58(nacl.randomBytes(128), B58_MAP);
                            }
                            //registration completion
                            EPK.onEmailDone = function(error){
                                //registration error
                                if(error !== undefined){
                                    _encrypt_done(undefined, error);
                                }
                                //successful registration
                                else{
                                    from = EPK.getEmail();
                                    document.getElementById("encrypt-email").value = from;
                                    _encrypt_done("invite");
                                }
                            };

                            //start registration
                            EPK.setEmail(from, passphrase);
                        }
                        else{
                            _encrypt_done("invite");
                        }
                        return;
                    }

                    document.getElementById("encrypt-error").innerHTML = "Your recipients need to have a code in their email (e.g. joe+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@gmail.com).";
                    document.getElementById("encrypt-button").innerHTML = "Encrypt";
                    document.getElementById("encrypt-button").disabled = null;
                    return;
                }
                //only some recipients are invalid
                else if(invalid_recipients.length){
                    document.getElementById("encrypt-error").innerHTML = "Some of your recipients don't have an encryption code in their email. All recipients need this code.";
                    document.getElementById("encrypt-button").innerHTML = "Encrypt";
                    document.getElementById("encrypt-button").disabled = null;
                    return;
                }

                //use the current user to encrypt if it matches the from field and there's no new passphrase
                var cur_user = EPK.getEmail();
                if(cur_user === from && passphrase === ""){
                    EPK.onEncryptDone = _encrypt_done;
                    EPK.encrypt(msg, valid_recipients.concat(cur_user));
                }
                //otherwise, register a new user+passphrase
                else{
                    //random passphrase if the user didn't enter one
                    if(passphrase === ""){
                        passphrase = to_b58(nacl.randomBytes(128), B58_MAP);
                    }

                    //registration completion
                    EPK.onEmailDone = function(error){
                        //registration error
                        if(error !== undefined){
                            _encrypt_done(undefined, error);
                        }
                        //successful registration
                        else{
                            //update the from field with the new email
                            from = EPK.getEmail();
                            document.getElementById("encrypt-email").value = from;

                            //encrypt the message
                            EPK.onEncryptDone = _encrypt_done;
                            EPK.encrypt(msg, valid_recipients.concat(EPK.getEmail()));
                        }
                    };

                    //start registration
                    EPK.setEmail(from, passphrase);
                }
            }

            //toggle send dropdown (for mobile users who can't hover)
            function click_send_toggle(e){
                if(e !== undefined) e.preventDefault();

                //switch the +/- symbol
                e.target.innerHTML = e.target.innerHTML === "+" ? "-" : "+";

                //force show/hide the dropdown
                var options = document.querySelectorAll("#send-selector li");
                for(var i = 1; i < options.length; i++){
                    if(options[i].style.display === ""){
                        options[i].style.display = "block";
                    }
                    else{
                        options[i].style.display = "";
                    }
                }
            }

            //bind events
            document.getElementById("forget").onclick = click_forget;
            document.getElementById("user-email").onblur = repopulate_email;
            document.getElementById("compose").onclick = click_compose;
            document.getElementById("read").onclick = click_read;
            document.getElementById("text").onblur = repopulate_text; //this is the only event changed outside of this block
            document.getElementById("decrypt-button").onclick = click_decrypt;
            document.getElementById("reply-button").onclick = click_reply;
            document.getElementById("reply-all-button").onclick = click_reply_all;
            document.getElementById("decrypt-emails").onchange = change_decrypt_emails;
            document.getElementById("decrypt-now").onclick = click_decrypt_now;
            document.getElementById("decrypt-now-cancel").onclick = click_decrypt_now_cancel;
            document.getElementById("decrypt-cancel").onclick = click_compose;
            document.getElementById("encrypt-show-cc").onclick = click_add_cc;
            document.getElementById("encrypt-email").onblur = blur_encrypt_email;
            document.getElementById("encrypt-button").onclick = click_encrypt;
            document.getElementById("send-toggle").onclick = click_send_toggle;

            //parse url arguments
            if(window.location.search){

                //handle invite special case
                var is_invite = parse_params(window.location.href);
                if(typeof(is_invite) !== "string" && is_invite['msg'] === "invite"){
                    var invite_to = is_invite['to'].length !== 1 ? undefined : is_invite['to'][0];
                    click_compose(
                        undefined,
                        invite_to,
                        is_invite['from'],
                        undefined,
                        is_invite['subject'],
                        "This is my reply. Set a passphrase, click 'Encrypt', then send via Gmail/Yahoo/Outlook.");
                }
                else{
                    //switch to read input and paste url into input
                    click_read(undefined, window.location.href);
                }
            }
            //default is to show the compose window
            else{
                click_compose();
            }

            /*
            //Manual debug test that runs through all the encrypt/decrypt functionality
            var EPK = new EmailPK();

            //fires on email creation or login
            EPK.onEmailDone = function(error){

                //errors are strings or undefined
                if(error !== undefined){
                    console.log("Email error: " + error);
                    return;
                }
                refresh_user();

                //get the created email
                var my_email = EPK.getEmail();
                console.log("Email: " + my_email);

                //fires on encrypt completion
                EPK.onEncryptDone = function(enc_txt, error){

                    //errors are strings or undefined
                    if(error !== undefined){
                        console.log("Encryption error: " + error);
                        return;
                    }

                    console.log("Encrypted message: " + enc_txt);

                    //fires on decrypt completion
                    EPK.onDecryptDone = function(text, error){
                        //errors are strings or undefined
                        if(error !== undefined){
                            console.log("Decryption error: " + error);
                            return;
                        }

                        console.log("Decrypted message from '" + my_email + "': " + text);
                    }

                    //decrypt the text
                    EPK.decrypt(enc_txt, my_email);
                }
                EPK.encrypt("Hello World!", [my_email]);
            }
            //EPK.setEmail("test@example.com", "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa");
            EPK.setEmail("test+HstYnGCssTKujt9VZqtrSPywFZ4ip4MUUXsZ7KneFHpX@example.com", "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa");
            */
        </script>
    </body>
</html>
